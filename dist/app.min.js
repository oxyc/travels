(function(t,e,a,i){"use strict";function r(t){return t.slice(1).map(function(e,a){return[t[a],e]})}function o(t,e){var a=b(t.properties);e.bindPopup(a)}function n(t,i){t.properties.distance=e.reduce(r(t.geometry.coordinates),function(t,e){return t+a.latLng(e[0][1],e[0][0]).distanceTo(a.latLng(e[1][1],e[1][0]))},0);var o=C(t.properties);i.bindPopup(o)}function l(t,i){var r=t.properties.type.toLowerCase();t.properties.homebase?r="homebase":["national park","nature reserve"].indexOf(r)!==-1?r="park":w.markers.hasOwnProperty(r)||(r="visited");var o=w.markers[r];return t.properties.visited||(o=e.clone(o),o.color="#999"),a.marker(i,{icon:a.MakiMarkers.icon(o)})}function s(t){return w.routeStyles[t.properties.type.toLowerCase()]}function c(t){var e=a.map(t,{center:[18,0],zoom:2,minZoom:2,maxZoom:10,scrollWheelZoom:!1});return a.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}"+(a.Browser.retina?"@2x":"")+".png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"oxy.ndp8318l",accessToken:"pk.eyJ1Ijoib3h5IiwiYSI6InBMaXRxSDAifQ.w9NqRLivEBn6BoMRkKmg3A"}).addTo(e),e}function d(t,r,o){var n=e.chain(r).filter(function(t){return"Topology"!==t.features.type||t.features.arcs.length}).forEach(function(e){if("Topology"===e.features.type){var r=a.geoJson(null,o);e.layer=i.topojson.parse(e.features,null,r)}else e.layer=a.geoJson(e.features,o);e.layer.type=t,e.layer.id=e.properties.id}).indexBy(function(t){return t.properties.name}).value();return e.mapValues(n,"layer")}function u(t,e){var i=a.control.layers(null,e,{collapsed:!0}).addTo(w.lMap),r=i.getContainer();return a.DomUtil.addClass(r,"control-custom"),a.DomUtil.addClass(r,"control-"+t),a.Browser.touch?a.DomEvent.disableClickPropagation(r):a.DomEvent.disableClickPropagation(r).disableScrollPropagation(r),i}function p(a,i,r){for(var o=e.chain(a._layers).pick(function(t){return i.indexOf(t.layer.id)!==-1}).keys().value(),n=a._form.getElementsByTagName("input"),l=0,s=n.length;l<s;l++){var c=n[l];o.indexOf(String(c.layerId))!==-1&&(r&&c.checked||(r||c.checked)&&t(c).trigger("click"))}}function f(t,e){var a=s(t);n(t,e),e.setStyle(a),function(){e.on("mouseover",function(){e.setStyle(w.routeStyles.mouseover)}),e.on("mouseout",function(){e.setStyle(a)})}()}function h(){var t=new a.Control.Search({layer:w.cluster,propertyName:"name",circleLocation:!1,initial:!1,autoCollapse:!0,zoom:10});return t.on("search_locationfound",function(t){D(t.layer)}),t}function m(t){t=t.sort(function(t,e){return t.properties.id<e.properties.id?-1:t.properties.id>e.properties.id?1:0});var i=d("country",t,{onEachFeature:o,pointToLayer:l}),r={};e.forEach(i,function(t,e){r[e]=a.layerGroup(),r[e].type="country",r[e].id=t.id,k.length&&k.indexOf(t.id)===-1||(r[e].addTo(w.lMap),w.cluster.addLayer(t))});var n=w.controls.country=u("country",r);for(var s in n._layers)n._layers.hasOwnProperty(s)&&($[a.Util.stamp(n._layers[s].layer)]=n._layers[s].name);return w.lMap.on("overlayadd overlayremove",function(t){var e=$[a.Util.stamp(t.layer)];"country"===t.layer.type&&("overlayadd"===t.type?w.cluster.addLayer(i[e]):w.cluster.removeLayer(i[e]))}),i}function g(t){var i=d("trip",t,{onEachFeature:f});k.length||e.forEach(i,function(t){t.addTo(w.lMap)});var r=w.controls.trip=u("trip",i);for(var o in r._layers)r._layers.hasOwnProperty(o)&&($[a.Util.stamp(r._layers[o].layer)]=r._layers[o].name);w.lMap.on("overlayadd overlayremove",function(i){var r=$[a.Util.stamp(i.layer)];if("trip"===i.layer.type){var o=t[r],n=e.pluck(o.properties.countries,"name"),l=w.controls.country,s="overlayadd"===i.type;p(l,n,s)}}),x.length&&(e.chain(i).pick(function(t){return x.indexOf(t.id)===-1}).forEach(function(t){w.lMap.removeLayer(t)}).value(),e.chain(i).pick(function(t){return x.indexOf(t.id)!==-1}).forEach(function(t){w.lMap.removeLayer(t),w.lMap.addLayer(t)}).value())}function y(i){var r=e.forEach(i.trips,function(e){e.promise=t.ajax({dataType:"json",url:"/"+e.path,timeout:v})});w.lMap.once("zoomstart",function(){w.$map.css("background-image","none")}),w.lMap.on("overlayadd overlayremove",e.debounce(function(t){if(t.layer.type&&"country"===t.layer.type){var e=w.cluster.getLayers();if(!e.length)return;for(var i=new a.LatLngBounds,r=0,o=e.length;r<o;r++)i.extend(e[r].getLatLng());w.lMap.fitBounds(i)}},100)),m(i.countries),w.lMap.addControl(h()),t.whenAll.apply(null,e.pluck(r,"promise")).always(function(){r=e.chain(r).pick(function(t){return 200===t.promise.statusCode().status}).forEach(function(t){t.features=t.promise.responseJSON}).indexBy(function(t){return t.properties.name}).value(),g(r),w.controls.other||(w.controls.other=a.control.layers(null,null,{collapsed:!1}).addTo(w.lMap),w.controls.other.addOverlay(w.cluster,"Markers"))})}a.Icon.Default.imagePath="/dist/images";var v=(window.matchMedia&&window.matchMedia("(max-width: 50rem)").matches,5e3),w={};w.lMap=c("world-map"),w.cluster=a.markerClusterGroup({maxClusterRadius:20}).addTo(w.lMap),w.$map=t("#world-map"),w.controls={},w.markers={trek:{icon:"campsite",color:"#159957"},city:{icon:"circle",color:"#659CD6"},park:{icon:"park",color:"#159957"},homebase:{icon:"building",color:"#D85E5E"},photo:{icon:"camera",color:"#659CD6",size:"s"},visited:{color:"#659CD6"}},w.routeStyles={trek:{color:"#159957",opacity:1,weight:5},route:{color:"#000",opacity:1,weight:2},tour:{color:"#000",opacity:1,weight:2},flight:{color:"#000",opacity:.3,weight:2},boat:{color:"#2057D0",opacity:.3,weight:2},mouseover:{color:"#ff0000",opacity:.7,weight:3}};var x=w.$map.data("trips").split(" ")||[],k=w.$map.data("country").split(" ")||[];x=e.reject(x,e.isEmpty),k=e.reject(k,e.isEmpty);var $={};t.getJSON("/world.json").done(y);var b=e.template('<strong><%- name %>, <%- _.startCase(country) %></strong> <small><%- type %></small><br><% if (!visited) { %><em>planning to visit</em><br><% } %><% if (typeof homebase !== "undefined" && homebase) { %><em>I used to live here</em><% } %><% if (typeof description !== "undefined") { %><span class="description"><%- description %></span><% } %>'),C=e.template("<strong><%- name %></strong> <small><%- type %></small><br>Distance: <%- Math.round(distance / 1000) %> km"),D=w.openPopup=function(t){return!(!w.cluster.hasLayer(t)||!t._icon&&!t.__parent._icon)&&void w.cluster.zoomToShowLayer(t,function(){t._popup&&t.openPopup()})};this.tMap=w}).call(this,jQuery,this._,this.L,this.omnivore),function(t,e,a,i){"use strict";function r(t,a){e.isNull(a)?e.omit(M,t):M[t]=a;var i=e.map(M,function(t,e){return e+"="+t});window.location.hash=i.join("&")}function o(t,e){return t+$(e)}function n(t,e){return t+'<div><img data-lazy="'+e.thumbnail+'"></div>'}function l(e){e.resized||(t(window).trigger("resize"),e.resized=!0),e.parent().removeClass("hidden")}function s(t){t.parent().addClass("hidden"),r("slide",null)}function c(t,e){var a=t.find(".slick-slide").filter('[data-id="'+e+'"]'),i=a.data("slick-index");t.slick("slickGoTo",i)}function d(t){var e=a.popup({className:"popup-photo"}).setContent(b(t)),r=a.marker(t.latlng,{icon:a.MakiMarkers.icon(i.markers.photo)}).bindPopup(e);return r.feature={properties:{name:"Photo"}},r}function u(t){var a=e.isEmpty(t.media$group.media$keywords)?[]:t.media$group.media$keywords.$t.split(", "),i=e.mapValues(t.exif$tags,function(t){return!!t.$t&&t.$t}),r=i.exif$make&&i.exif$model?i.exif$make+" "+i.exif$model:"unknown",o=t.georss$where&&t.georss$where.gml$Point&&t.georss$where.gml$Point.gml$pos&&t.georss$where.gml$Point.gml$pos.$t&&t.georss$where.gml$Point.gml$pos.$t.split(" ");return e.assign({id:t.gphoto$id.$t,original:t.media$group.media$content[0].url,large:t.media$group.media$thumbnail[0].url,thumbnail:t.media$group.media$thumbnail[1].url,tags:a,size:t.gphoto$size.$t,width:t.gphoto$width.$t,height:t.gphoto$height.$t,description:t.media$group.media$description.$t,latlng:o,exif$make:!1,exif$model:!1,exif$fstop:!1,exif$exposure:!1,exif$focallength:!1,exif$iso:!1,exif$time:!1,exif$flash:!1,CROP_FACTOR:w.hasOwnProperty(r)?w[r]:1},i)}function p(t){var r=a.layerGroup(e.values(t)),o=a.layerGroup();i.controls.other||(i.controls.other=a.control.layers(null,null,{collapsed:!1}).addTo(i.lMap)),r.type="photo",o.type="photo",i.controls.other.addOverlay(o,"Photos"),i.lMap.on("overlayadd overlayremove",function(t){"photo"===t.layer.type&&("overlayadd"===t.type?i.cluster.addLayer(r):i.cluster.removeLayer(r))})}function f(a){var o=a.find(".slideshow"),n=a.find(".slideshow-overlay"),d=n.find(".tag-filters"),u=a.find(".close"),p=a.find(".open");p.on("click",l.bind(null,o)),u.on("click",s.bind(null,o)),a.on("click",".view-exif",m),a.on("click",".filter-tags",g.bind(null,d,C)),a.on("change","select.filter",function(a){var i=t(a.target).val();r("tags",e.isArray(i)?i.join(","):i),h(o,{tags:i})}),o.on("afterChange",function(){var t=o.slick("slickCurrentSlide");r("slide",t)}),a.on("click",".view-on-map",function(e){e.preventDefault(),s(o);var a=t(this).data("id"),r=D[a];i.openPopup(r)||(i.lMap.panTo(r.getLatLng()),i.lMap.setZoom(10))}),t(document).on("click",".leaflet-popup a.photo-popup",function(e){e.preventDefault();var a=t(this).data("id");l(o),c(o,a)})}function h(a,i){var r=a.slick("slickGetOption","asNavFor"),o=t(r);if(a.slick("slickUnfilter"),o.slick("slickUnfilter"),i.tags&&!e.isEmpty(i.tags)){var n=[];a.slick("slickFilter",function(t,e){var a=e.dataset&&e.dataset.slickIndex;if(!a)return!0;var r=e.dataset.tags.split(",");if(0===r.length)return!1;for(var o=0,l=i.tags.length;o<l;o++)if(r.indexOf(i.tags[o])===-1)return!1;return n.push(a),!0}),o.slick("slickFilter",function(t,e){var a=e.dataset&&e.dataset.slickIndex;return!a||n.indexOf(a)!==-1})}}function m(e){e.preventDefault();var a=t(this).parent().parent();a.find(".exif-data").hasClass("hidden")?a.parent().find(".exif-data").removeClass("hidden"):a.parent().find(".exif-data").addClass("hidden")}function g(t,e,a){a.preventDefault(),t.hasClass("filters-initialized")?t.hasClass("hidden")?t.removeClass("hidden"):t.hasClass("hidden")||t.addClass("hidden"):(t.html(k({tags:e})),t.addClass("filters-initialized"),t.find("select").select2({placeholder:"Select which tags to show"}))}function y(t,a,r){var l=t.find(".slideshow"),s=t.find(".slideshow-nav"),c=a.feed.entry;return r.albumTags&&(c=e.filter(c,function(t){if(e.isEmpty(t.media$group.media$keywords))return!1;var a=t.media$group.media$keywords.$t.split(", ");return e.intersection(a,r.albumTags).length>0})),c.length?(c=e.chain(c).map(u).forEach(function(t){e.forEach(t.tags,function(t){C[t]=0}),t.latlng&&(D[t.id]=d(t))}).value(),l.append(e.reduce(c,o,"")),s.append(e.reduce(c,n,"")),f(t,{tags:C,locations:D}),!e.isEmpty(D)&&i.lMap&&p(D),l.slick({asNavFor:".slideshow-nav",lazyLoad:"ondemand",slidesToShow:1,slidesToScroll:1,fade:!0,arrows:!0,infinite:!1}),s.slick({asNavFor:".slideshow",lazyLoad:"ondemand",slidesToShow:v?9:18,arrows:!1,focusOnSelect:!0,infinite:!1}),l):(t.find(".open").hide(),null)}var v=window.matchMedia&&window.matchMedia("(max-width: 50rem)").matches,w={"FUJIFILM X-E2":1.5},x=e.template("https://picasaweb.google.com/data/feed/api/user/<%- userId %>/<% if (albumId) { %>albumid/<%- albumId %>/<% } %>?alt=json&kind=photo&imgmax=d&thumbsize=1024,72&fields=entry(exif:tags,georss:where,gphoto:size,gphoto:width,gphoto:height,gphoto:id,media:group(media:content,media:thumbnail,media:keywords,media:description))"),k=e.template('<h4>Filter by tag</h4><select multiple="multipe" class="filter"><% _.forEach(tags, function (active, tag) { %><option><%- tag %></option><% }) %></select>'),$=e.template('<div data-tags="<%- tags.join(",") %>" data-id="<%- id %>"><img data-lazy="<%- large %>"><% if (description) { %><div class="description"><%- description %></div><% } %><div class="exif-data overlay hidden"><table><% if (exif$make && exif$model) { %><tr><th>Camera</th><td><%- exif$make  %> <%- exif$model %></td></tr><% } if (exif$fstop) { %><tr><th>Aperture</th><td>f/<%- parseInt(exif$fstop, 10) %></td></tr><% } if (exif$exposure) { %><tr><th>Exposure</th><td><%- new Fraction(parseFloat(exif$exposure)).toFraction() %></td></tr><% } if (exif$focallength) { %><tr><th>Focal length</th><td><%- parseInt(exif$focallength * CROP_FACTOR, 10) %> mm</td></tr><% } if (exif$iso) { %><tr><th>ISO</th><td><%- exif$iso %></td></tr><% } if (exif$flash) { %><tr><th>Flash</th><td><% if (exif$flash === "false") { %>No<% } else { %>Yes<% } %></td></tr><% } if (exif$time) { %><tr><th>Date</th><td><%- new Date(parseInt(exif$time)).toUTCString().slice(0, -7) %></td></tr><% } if (width && height) { %><tr><th>Dimensions</th><td><%- width %>x<%- height %></td></tr><% } if (size) { %><tr><th>Size</th><td><%- (size / 1024 / 1024).toFixed(2) %> MB</td></tr><% } if (tags) { %><tr><th>Tags</th><td class="tags"><%- tags.join(", ") %></td></tr><% } %></table></div><div class="additional overlay"><a href="#" class="view-exif" data-image="<%- original %>">View info</a><% if (latlng) { %><a href="#" class="view-on-map" data-id="<%- id %>" data-lng="<% latlng[1] %>">View on map</a><% } %><a href="#" class="filter-tags">Filter by tag</a><a href="<%- original %>" class="download" download>Download original</a></div></div>'),b=e.template('<a href="#" class="photo-popup" data-id="<%- id %>"><img src="<%- thumbnail %>"></a>'),C={},D={},M=function(){var t={};return e.forEach(window.location.hash.split("&"),function(a){a&&(a=a.split("=")||[a,""],t[e.trim(a[0],"#")]=a[1])}),t}();t(".picasa-album").each(function(){var e=t(this),a=e.find(".slideshow"),i={albumId:a.data("albumid"),userId:a.data("userid"),albumTags:a.data("albumtags").split(" ")};t.getJSON(x(i)).done(function(a){var r=y(e,a,i);M.tags&&(e.find(".filter-tags").trigger("click"),e.find("select.filter").val(M.tags.split(",")),e.find("select.filter").trigger("change")),M.slide&&r.slick("slickGoTo",M.slide),(M.tags||M.slide)&&t(".picasa-album .open").trigger("click")})})}(this.jQuery,this._,this.L,this.tMap),function(t,e){"use strict";function a(e,a){e.tooltipInitalizer=!0,d.not(e).trigger("hidetooltip");var i=t(e).tinytooltip({message:f({data:a}),hover:!1}).trigger("showtooltip");u=!0,d=d.add(i)}function i(t){return p.indexOf(t)===-1}function r(t){var a=(c.end-c.start)/1e3/3600/24+1,i=e.chain(t).filter("visible").reduce(function(t,e){return t+h[e.name]},0).value();return{value:i/a,color:"red",width:2,zIndex:20,id:"plot-average"}}function o(t){return e.chain(t).indexBy("name").mapValues(function(t){return e.reduce(t.dates,function(t,e){var a=new Date(e.start),i=new Date(e.end);return t+(i-a)/1e3/3600/24+1},0)}).value()}function n(t){var a=e.now(),i=0;return e.chain(t).pluck("dates").flatten().each(function(t){var e=new Date(t.start),r=new Date(t.end);e<a&&(a=e),r>i&&(i=r)}).value(),{start:a,end:i}}function l(a){s.each(function(){var i=t(this),r=i.data("chart"),o={trip:i.data("trip"),country:i.data("country"),title:i.data("title"),countryData:[]},n=e.chain(a.expenditures).filter("trip",o.trip).each(function(t){o.countryData.push(t.countries)}).pluck("data").flatten().value();return o.countryData=e.chain(o.countryData).flatten(o.countryData).filter(function(t){return t.dates.length>0}).value(),o.country&&(n=e.filter(n,"country",o.country),o.countryData=e.filter(o.countryData,"name",o.country)),o.countryData.length?void m[r](i,n,o):void i.html("<p><em>No data available yet</em></p>")}),t(document).on("click",function(t){!u||t.target&&t.target.tooltipInitalizer||(d.trigger("hidetooltip"),u=!1)})}var s=t(".expenditure-chart");s.length&&t.getJSON("/expenditures.json",l);var c,d=t(),u=!1,p=["flight","boat","tour"],f=e.template('<table><tr><th>Date</th><th>Amount</th><th>Description</th></tr><% _.forEach(data, function (row) { %><tr><td><%- row.date %><td>$<%- row.amount %></td><td><%- row.description || "" %></td></tr><% }); %></table>'),h={},m={perTagCPD:function(t,i,r){var n=o(r.countryData);n=n[r.country];var l=e.chain(i).groupBy("tags").map(function(t,a){var i=e.sum(t,"amount");return i=Math.round(i/n*100)/100,{name:a,y:i}}).value();t.highcharts({chart:{type:"pie"},plotOptions:{pie:{allowPointSelect:!0,dataLabels:{enabled:!1},showInLegend:!0,events:{click:function(t){var r=t.point.name,o=e.filter(i,function(t){return t.tags===r});a(t.target,o)}}}},tooltip:{valuePrefix:"$",valueSuffix:"/day",pointFormat:"<b>{point.y} ({point.percentage:.1f}%)</b><br/>"},title:{text:r.title||""},series:[{name:"Tags",data:l}]})},perCountryCPD:function(t,l,s){var d=e.pluck(s.countryData,"name"),u=o(s.countryData);c=n(s.countryData);var p=e.chain(l).groupBy("tags").map(function(t,a){var r=e.fill(Array(d.length),0),o=0;return e.chain(t).groupBy("country").each(function(t,a){var i=e.indexOf(d,a),n=u[a];if(n){var l=e.sum(t,"amount");o+=l,r[i]=l/n,r[i]=Math.round(100*r[i])/100}}).value(),h[a]=o,{name:a,visible:i(a),data:r}}).value();t.highcharts({chart:{type:"bar",events:{redraw:function(){var t=this.axes[1];t.removePlotLine("plot-average"),t.addPlotLine(r(t.series))}}},xAxis:{categories:d},yAxis:{min:0,title:{text:"Cost per day"},labels:{format:"${value}"},stackLabels:{enabled:!0,style:{color:"#999",fontWeight:"normal",textShadow:"none"}},plotLines:[r(p)]},legend:{reversed:!0},plotOptions:{series:{stacking:"normal"},bar:{events:{click:function(t){var i=t.point.category,r=this.name,o=e.filter(l,function(t){return t.country===i&&t.tags===r});a(t.target,o)}}}},tooltip:{valuePrefix:"$"},title:{text:s.title||""},series:p})}}}.call(this,this.jQuery,this._),function(t,e){var a=t("#commit-history");if(a.length){var i="https://api.github.com/repos/oxyc/travels/commits",r=e.template('<li><a href="<%- html_url %>"><span class="date"><%- new Date(commit.author.date).toDateString() %></span> <%- commit.message %></li>');t.getJSON(i).done(function(t){var i=e.reduce(t,function(t,e){return t+r(e)},"");console.log(i),a.html(i)})}}(this.jQuery,this._);